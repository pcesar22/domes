// Runtime configuration protocol for DOMES firmware
// Shared between firmware (nanopb) and host CLI (prost)
//
// THIS IS THE SINGLE SOURCE OF TRUTH FOR ALL CONFIG PROTOCOL DEFINITIONS.
// DO NOT duplicate these definitions in firmware or CLI code.
syntax = "proto3";
package domes.config;

// Frame-level message types for config protocol
// Used in the frame header [0xAA 0x55][Len][MsgType][Payload][CRC32]
enum MsgType {
    MSG_TYPE_UNKNOWN = 0;

    // Config commands (0x20-0x2F range)
    MSG_TYPE_LIST_FEATURES_REQ = 0x20;
    MSG_TYPE_LIST_FEATURES_RSP = 0x21;
    MSG_TYPE_SET_FEATURE_REQ = 0x22;
    MSG_TYPE_SET_FEATURE_RSP = 0x23;
    MSG_TYPE_GET_FEATURE_REQ = 0x24;
    MSG_TYPE_GET_FEATURE_RSP = 0x25;
    MSG_TYPE_SET_LED_PATTERN_REQ = 0x26;
    MSG_TYPE_SET_LED_PATTERN_RSP = 0x27;
    MSG_TYPE_GET_LED_PATTERN_REQ = 0x28;
    MSG_TYPE_GET_LED_PATTERN_RSP = 0x29;
    MSG_TYPE_SET_IMU_TRIAGE_REQ = 0x2A;
    MSG_TYPE_SET_IMU_TRIAGE_RSP = 0x2B;

    // System mode commands (0x30-0x37 range)
    MSG_TYPE_GET_MODE_REQ = 0x30;
    MSG_TYPE_GET_MODE_RSP = 0x31;
    MSG_TYPE_SET_MODE_REQ = 0x32;
    MSG_TYPE_SET_MODE_RSP = 0x33;
    MSG_TYPE_GET_SYSTEM_INFO_REQ = 0x34;
    MSG_TYPE_GET_SYSTEM_INFO_RSP = 0x35;
    MSG_TYPE_SET_POD_ID_REQ = 0x36;
    MSG_TYPE_SET_POD_ID_RSP = 0x37;
}

// Status codes for responses
enum Status {
    STATUS_OK = 0;
    STATUS_ERROR = 1;
    STATUS_INVALID_FEATURE = 2;
    STATUS_BUSY = 3;
    STATUS_INVALID_PATTERN = 4;
}

// LED pattern types
enum LedPatternType {
    LED_PATTERN_OFF = 0;
    LED_PATTERN_SOLID = 1;
    LED_PATTERN_BREATHING = 2;
    LED_PATTERN_COLOR_CYCLE = 3;
}

// RGBW color (0-255 per channel)
message Color {
    uint32 r = 1;
    uint32 g = 2;
    uint32 b = 3;
    uint32 w = 4;  // White channel (ignored for RGB-only LEDs)
}

// Runtime-toggleable features
enum Feature {
    FEATURE_UNKNOWN = 0;
    FEATURE_LED_EFFECTS = 1;
    FEATURE_BLE_ADVERTISING = 2;
    FEATURE_WIFI = 3;
    FEATURE_ESP_NOW = 4;
    FEATURE_TOUCH = 5;
    FEATURE_HAPTIC = 6;
    FEATURE_AUDIO = 7;
}

// Feature with its current state
message FeatureState {
    Feature feature = 1;
    bool enabled = 2;
}

// Request messages
message ListFeaturesRequest {
    // Empty - lists all features
}

message SetFeatureRequest {
    Feature feature = 1;
    bool enabled = 2;
}

// LED pattern with parameters
message LedPattern {
    LedPatternType type = 1;
    Color color = 2;              // Primary color (for solid/breathing)
    repeated Color colors = 3;    // Color list (for color_cycle)
    uint32 period_ms = 4;         // Animation period in ms
    uint32 brightness = 5;        // Global brightness (0-255)
}

message SetLedPatternRequest {
    LedPattern pattern = 1;
}

message GetLedPatternRequest {
    // Empty - returns current pattern
}

// Response messages
message ListFeaturesResponse {
    repeated FeatureState features = 1;
    uint32 pod_id = 2;  // Pod identity (0 = not set)
}

message SetFeatureResponse {
    FeatureState feature = 1;
}

message SetLedPatternResponse {
    LedPattern pattern = 1;
}

message GetLedPatternResponse {
    LedPattern pattern = 1;
}

// IMU triage mode messages
message SetImuTriageRequest {
    bool enabled = 1;
}

message SetImuTriageResponse {
    bool enabled = 1;
}

// System operating modes
enum SystemMode {
    SYSTEM_MODE_BOOTING = 0;
    SYSTEM_MODE_IDLE = 1;
    SYSTEM_MODE_TRIAGE = 2;
    SYSTEM_MODE_CONNECTED = 3;
    SYSTEM_MODE_GAME = 4;
    SYSTEM_MODE_ERROR = 5;
}

// System mode messages
message GetModeRequest {
    // Empty - returns current mode
}

message GetModeResponse {
    SystemMode mode = 1;
    uint32 time_in_mode_ms = 2;
}

message SetModeRequest {
    SystemMode mode = 1;
}

message SetModeResponse {
    SystemMode mode = 1;
    bool transition_ok = 2;
}

message GetSystemInfoRequest {
    // Empty - returns system info
}

message GetSystemInfoResponse {
    string firmware_version = 1;
    uint32 uptime_s = 2;
    uint32 free_heap = 3;
    uint32 boot_count = 4;
    SystemMode mode = 5;
    uint32 feature_mask = 6;
    uint32 pod_id = 7;  // Pod identity (0 = not set)
}

// Set pod ID (persisted to NVS)
message SetPodIdRequest {
    uint32 pod_id = 1;  // 1-255
}

message SetPodIdResponse {
    uint32 pod_id = 1;  // New pod ID after write
}

// Top-level request envelope
message ConfigRequest {
    oneof request {
        ListFeaturesRequest list_features = 1;
        SetFeatureRequest set_feature = 2;
    }
}

// Top-level response envelope
message ConfigResponse {
    Status status = 1;
    oneof response {
        ListFeaturesResponse list_features = 2;
        SetFeatureResponse set_feature = 3;
    }
}
