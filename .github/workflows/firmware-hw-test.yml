name: Hardware Tests

on:
  # Trigger when 'hw-test' label is added to a PR
  pull_request:
    types: [labeled]

  # Also run on push to main (post-merge verification)
  push:
    branches: [main]
    paths:
      - 'firmware/**'
      - 'tools/domes-cli/**'

  # Keep manual trigger as backup
  workflow_dispatch:
    inputs:
      ports:
        description: 'Comma-separated serial ports (e.g., /dev/ttyACM0,/dev/ttyACM1)'
        required: false
        default: '/dev/ttyACM0'
      device_count:
        description: 'Number of devices to test (1 or 2)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

# CRITICAL: Only one hardware test can run at a time
# Jobs are queued (not cancelled) when another is running
concurrency:
  group: hardware-test-queue
  cancel-in-progress: false

env:
  # Comma-separated list of serial ports
  SERIAL_PORTS: ${{ github.event.inputs.ports || '/dev/ttyACM0' }}
  DEVICE_COUNT: ${{ github.event.inputs.device_count || '1' }}

jobs:
  hardware-test:
    name: On-Device Tests
    runs-on: self-hosted

    # Only run if:
    # - Label trigger AND label is 'hw-test', OR
    # - Push to main, OR
    # - Manual dispatch
    if: |
      (github.event_name == 'pull_request' && github.event.label.name == 'hw-test') ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Detect devices
        id: detect
        run: |
          echo "=== Detecting connected DOMES devices ==="

          # Parse comma-separated ports into array
          IFS=',' read -ra PORTS <<< "$SERIAL_PORTS"

          # Auto-detect if only default port specified
          if [ "${#PORTS[@]}" -eq 1 ] && [ "${PORTS[0]}" = "/dev/ttyACM0" ]; then
            DETECTED=()
            for port in /dev/ttyACM*; do
              if [ -e "$port" ]; then
                DETECTED+=("$port")
              fi
            done
            if [ ${#DETECTED[@]} -gt 0 ]; then
              PORTS=("${DETECTED[@]}")
            fi
          fi

          echo "Detected ${#PORTS[@]} device(s):"
          for port in "${PORTS[@]}"; do
            if [ -e "$port" ]; then
              echo "  OK: $port"
            else
              echo "  MISSING: $port"
            fi
          done

          # Export for subsequent steps
          PORT_LIST=$(IFS=','; echo "${PORTS[*]}")
          echo "ports=$PORT_LIST" >> $GITHUB_OUTPUT
          echo "count=${#PORTS[@]}" >> $GITHUB_OUTPUT
          echo "primary=${PORTS[0]}" >> $GITHUB_OUTPUT

          if [ ${#PORTS[@]} -ge 2 ]; then
            echo "secondary=${PORTS[1]}" >> $GITHUB_OUTPUT
            echo "multi=true" >> $GITHUB_OUTPUT
          else
            echo "secondary=" >> $GITHUB_OUTPUT
            echo "multi=false" >> $GITHUB_OUTPUT
          fi

          # Fail if no devices found
          if [ ! -e "${PORTS[0]}" ]; then
            echo "::error::No devices found. Available serial ports:"
            ls -la /dev/ttyACM* /dev/ttyUSB* 2>/dev/null || echo "None"
            exit 1
          fi

      - name: Build firmware
        working-directory: firmware/domes
        run: |
          . ~/esp/esp-idf/export.sh
          idf.py build
          echo "Firmware built successfully"
          echo "Binary size: $(stat -c%s build/domes.bin) bytes"

      - name: Build domes-cli
        working-directory: tools/domes-cli
        run: |
          cargo build --release
          echo "CLI built successfully"

      - name: Flash all devices
        working-directory: firmware/domes
        run: |
          . ~/esp/esp-idf/export.sh

          IFS=',' read -ra PORTS <<< "${{ steps.detect.outputs.ports }}"
          FAILED=0

          for port in "${PORTS[@]}"; do
            echo "=== Flashing $port ==="
            if idf.py -p "$port" flash; then
              echo "Flashed $port successfully"
            else
              echo "::error::Failed to flash $port"
              FAILED=$((FAILED + 1))
            fi
          done

          echo "Waiting for devices to boot..."
          sleep 5

          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED device(s) failed to flash"
            exit 1
          fi

      - name: Test - Feature List (all devices)
        run: |
          IFS=',' read -ra PORTS <<< "${{ steps.detect.outputs.ports }}"
          CLI=tools/domes-cli/target/release/domes-cli

          for port in "${PORTS[@]}"; do
            echo "=== Feature list: $port ==="
            $CLI --port "$port" feature list
            echo ""
          done
          echo "Feature list test passed on all devices"

      - name: Test - Serial OTA (primary device)
        run: |
          PRIMARY="${{ steps.detect.outputs.primary }}"
          echo "Testing Serial OTA on $PRIMARY..."

          tools/domes-cli/target/release/domes-cli \
            --port "$PRIMARY" \
            ota flash firmware/domes/build/domes.bin \
            --version "v0.0.0-ci-${{ github.sha }}"

          echo "OTA complete, waiting for reboot..."
          sleep 5

      - name: Test - Post-OTA Verification (primary device)
        run: |
          PRIMARY="${{ steps.detect.outputs.primary }}"
          echo "Verifying $PRIMARY responds after OTA..."
          tools/domes-cli/target/release/domes-cli --port "$PRIMARY" feature list
          echo "Post-OTA verification passed"

      - name: Test - Multi-Device Feature List
        if: steps.detect.outputs.multi == 'true'
        run: |
          echo "Testing multi-device feature list..."
          CLI=tools/domes-cli/target/release/domes-cli

          # Test with multiple --port flags
          $CLI \
            --port "${{ steps.detect.outputs.primary }}" \
            --port "${{ steps.detect.outputs.secondary }}" \
            feature list

          echo "Multi-device feature list passed"

      - name: Test - ESP-NOW Communication
        if: steps.detect.outputs.multi == 'true'
        continue-on-error: true  # ESP-NOW may not be implemented yet
        run: |
          echo "Testing ESP-NOW between devices..."
          echo "NOTE: This test requires ESP-NOW firmware support (may not be implemented yet)"

          CLI=tools/domes-cli/target/release/domes-cli
          PRIMARY="${{ steps.detect.outputs.primary }}"
          SECONDARY="${{ steps.detect.outputs.secondary }}"

          # Enable ESP-NOW on both devices
          $CLI --port "$PRIMARY" feature enable esp-now || echo "ESP-NOW not available on primary"
          $CLI --port "$SECONDARY" feature enable esp-now || echo "ESP-NOW not available on secondary"

          echo "ESP-NOW test placeholder - full test pending firmware implementation"

      - name: Test - WiFi Status (if enabled)
        continue-on-error: true
        run: |
          IFS=',' read -ra PORTS <<< "${{ steps.detect.outputs.ports }}"
          CLI=tools/domes-cli/target/release/domes-cli

          for port in "${PORTS[@]}"; do
            echo "Checking WiFi status on $port..."
            $CLI --port "$port" wifi status || true
          done

      - name: Summary
        run: |
          echo "## Hardware Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Devices**: ${{ steps.detect.outputs.count }} (${{ steps.detect.outputs.ports }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-device**: ${{ steps.detect.outputs.multi }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Firmware build" >> $GITHUB_STEP_SUMMARY
          echo "- [x] CLI build" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Flash all devices" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Feature list (all devices)" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Serial OTA (primary)" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Post-OTA verification" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.detect.outputs.multi }}" = "true" ]; then
            echo "- [x] Multi-device feature list" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] ESP-NOW communication (placeholder)" >> $GITHUB_STEP_SUMMARY
          fi
