name: Hardware Tests

on:
  # Trigger when 'hw-test' label is added to a PR
  pull_request:
    types: [labeled]

  # Also run on push to main (post-merge verification)
  push:
    branches: [main]
    paths:
      - 'firmware/**'
      - 'tools/domes-cli/**'

  # Keep manual trigger as backup
  workflow_dispatch:
    inputs:
      port:
        description: 'Serial port (e.g., /dev/ttyACM0)'
        required: false
        default: '/dev/ttyACM0'

# CRITICAL: Only one hardware test can run at a time
# Jobs are queued (not cancelled) when another is running
concurrency:
  group: hardware-test-queue
  cancel-in-progress: false

env:
  SERIAL_PORT: ${{ github.event.inputs.port || '/dev/ttyACM0' }}

jobs:
  hardware-test:
    name: On-Device Tests
    runs-on: self-hosted

    # Only run if:
    # - Label trigger AND label is 'hw-test', OR
    # - Push to main, OR
    # - Manual dispatch
    if: |
      (github.event_name == 'pull_request' && github.event.label.name == 'hw-test') ||
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Verify device connected
        run: |
          echo "Looking for device at $SERIAL_PORT..."
          if [ ! -e "$SERIAL_PORT" ]; then
            echo "::error::Device not found at $SERIAL_PORT"
            echo "Available serial ports:"
            ls -la /dev/ttyACM* /dev/ttyUSB* 2>/dev/null || echo "No serial devices found"
            exit 1
          fi
          echo "Device found at $SERIAL_PORT"

      - name: Build firmware
        working-directory: firmware/domes
        run: |
          . ~/esp/esp-idf/export.sh
          idf.py build
          echo "Firmware built successfully"
          echo "Binary size: $(stat -c%s build/domes.bin) bytes"

      - name: Build domes-cli
        working-directory: tools/domes-cli
        run: |
          cargo build --release
          echo "CLI built successfully"

      - name: Flash firmware via JTAG/USB
        working-directory: firmware/domes
        run: |
          . ~/esp/esp-idf/export.sh
          idf.py -p $SERIAL_PORT flash
          echo "Waiting for device to boot..."
          sleep 5

      - name: Test - Feature List
        run: |
          echo "Testing feature list command..."
          tools/domes-cli/target/release/domes-cli --port $SERIAL_PORT feature list
          echo "Feature list test passed"

      - name: Test - Serial OTA
        run: |
          echo "Testing Serial OTA update..."
          tools/domes-cli/target/release/domes-cli \
            --port $SERIAL_PORT \
            ota flash firmware/domes/build/domes.bin \
            --version v0.0.0-ci-${{ github.sha }}

          echo "OTA complete, waiting for reboot..."
          sleep 5

      - name: Test - Post-OTA Verification
        run: |
          echo "Verifying device responds after OTA..."
          tools/domes-cli/target/release/domes-cli --port $SERIAL_PORT feature list
          echo "Post-OTA verification passed"

      - name: Test - WiFi Status (if enabled)
        continue-on-error: true  # WiFi may not be configured
        run: |
          echo "Checking WiFi status..."
          tools/domes-cli/target/release/domes-cli --port $SERIAL_PORT wifi status || true

      - name: Summary
        run: |
          echo "## Hardware Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Device**: $SERIAL_PORT" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Firmware build" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Flash via JTAG" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Feature list command" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Serial OTA update" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Post-OTA verification" >> $GITHUB_STEP_SUMMARY
