name: Firmware CI

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - 'firmware/**'
      - '.github/workflows/firmware-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'firmware/**'
      - '.github/workflows/firmware-ci.yml'

jobs:
  build:
    name: Build ESP32-S3 Firmware
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.2.2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For git describe version
          submodules: recursive

      - name: Build firmware
        working-directory: firmware/domes
        run: |
          . $IDF_PATH/export.sh
          idf.py build

      - name: Check binary size
        run: |
          SIZE=$(stat -c%s firmware/domes/build/domes.bin)
          echo "Binary size: $SIZE bytes ($(numfmt --to=iec $SIZE))"

          # DevKit OTA partition = 1.875MB = 1,966,080 bytes
          MAX_SIZE=1966080

          if [ $SIZE -gt $MAX_SIZE ]; then
            echo "::error::Binary exceeds OTA partition size ($SIZE > $MAX_SIZE bytes)"
            exit 1
          fi

          echo "Size OK: $SIZE / $MAX_SIZE bytes ($(( SIZE * 100 / MAX_SIZE ))%)"

      - name: Generate firmware info
        run: |
          cd firmware/domes/build
          sha256sum domes.bin > domes.bin.sha256
          echo "SHA-256: $(cat domes.bin.sha256)"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: domes-firmware-${{ github.sha }}
          path: |
            firmware/domes/build/domes.bin
            firmware/domes/build/domes.bin.sha256
          retention-days: 30

  # Standalone unit tests using Google Test (host-only, no ESP-IDF target)
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Build and run tests
        working-directory: firmware/test_app
        run: |
          mkdir -p build
          cd build
          cmake ..
          make -j$(nproc)
          ctest --output-on-failure

  # Rust CLI build and tests
  cli-build:
    name: Build CLI Tool
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build CLI
        working-directory: tools/domes-cli
        run: cargo build --release

      - name: Run CLI tests
        working-directory: tools/domes-cli
        run: cargo test
